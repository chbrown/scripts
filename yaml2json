#!/usr/bin/env python
import sys
import json
from datetime import datetime, date

import yaml
try:
    from yaml import CLoader as Loader
    # from yaml import CDumper as CDumper
except ImportError:
    from yaml import Loader
    # from yaml import Dumper


class JSONEncoder(json.JSONEncoder):
    def default(self, obj):
        if isinstance(obj, datetime):
            return obj.strftime('%Y-%m-%dT%H:%M:%S')
        if isinstance(obj, date):
            return obj.strftime('%Y-%m-%d')
        return json.JSONEncoder.default(self, obj)


def yaml2json(fd_in, fd_out, indent=None):
    document = yaml.load(fd_in, Loader=Loader)
    json.dump(document, fd_out, cls=JSONEncoder, indent=indent)
    fd_out.write('\n')


def main():
    import argparse
    parser = argparse.ArgumentParser(description='Convert YAML to JSON',
        formatter_class=argparse.ArgumentDefaultsHelpFormatter)
    parser.add_argument('input', nargs='?', type=argparse.FileType('r'), default=sys.stdin,
        help='YAML path (defaults to STDIN)')
    parser.add_argument('output', nargs='?', type=argparse.FileType('w'), default=sys.stdout,
        help='JSON path (defaults to STDOUT)')
    parser.add_argument('--indent', action='store_true', help='Indent')
    opts = parser.parse_args()

    yaml2json(opts.input, opts.output, 2 if opts.indent else None)

if __name__ == '__main__':
    main()
