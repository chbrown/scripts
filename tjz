#!/usr/bin/env bash

set -e # exit on first command that fails

usage() {
  >&2 cat <<HELP
Usage: $(basename "$0") DIRPATH[/] [-g|--gzip] [-k|--keep] [-p|--prefix] [-h|--help]

Tarball and bzip2-compress DIRPATH into a new file, "./DIRPATH.tar.bz2",
then remove the original directory (using 'trash' if available; otherwise,
move it into \$TMPDIR).

Options:
  -g, --gzip    Use gzip instead of bzip2 compression
  -k, --keep    Keep (don't trash) the input directory
  -p, --prefix  Prefix the created tarball with the original directory's
                date-of-birth, using the pattern "YYYYMMDD-"
  -h, --help    Show this usage message
HELP
}

SUFFIX=bz2
COMPRESSOR=-j
KEEP=false
while [[ $# -gt 0 ]]; do
  case $1 in
    -h|--help)
      usage
      exit 0
      ;;
    -g|--gzip)
      SUFFIX=gz
      COMPRESSOR=-z
      ;;
    -k|--keep)
      KEEP=true
      ;;
    -p|--prefix)
      PREFIX_PATTERN=%Y%m%d-
      ;;
    *)
      # check that the given filepath exists and that it's a directory
      if [[ ! -e $1 ]]; then
        >&2 printf '"%s" does not exist.\n' "$1"
        exit 1
      elif [[ ! -d $1 ]]; then
        >&2 printf '"%s" is not a directory.\n' "$1"
        exit 1
      elif [[ -z ${INPUT+missing} ]]; then
        # INPUT hasn't been set yet; set it while removing
        # the trailing slash (hopefully there's only one)
        INPUT=${1%/}
      else
        usage
        >&2 printf '\nToo many arguments: "%s"\n' "$1"
        exit 1
      fi
      ;;
  esac
  shift
done

compress-dir() {
  # Usage: compress-dir input-directory output-filepath
  #
  # prepare timestamp to apply to output-filepath
  #   touch's -t argument is of the form "[[CC]YY]MMDDhhmm[.SS]"
  TIMESTAMP=$(find "$1" -type f -not -name .DS_Store -print0 | xargs -0 stat -f %SB -t %Y%m%d%H%M.%S | sort | tail -1)
  # prepare temporary file to write to
  TMPFILE=$(mktemp "$2.XXXXXXXXXX")
  trap "unlink $TMPFILE" EXIT
  # COPYFILE_DISABLE=1 ignores extended attributes (xattr) on Mac OS X
  # -c create a new archive
  # -j compress with bzip2 / -z compress with gzip
  # -f write to specified file
  # -C treats the parent directory as the path context
  # --exclude prevents files matching a pattern from being added
  COPYFILE_DISABLE=1 tar -c $COMPRESSOR -f "$TMPFILE" \
    -C "$(dirname "$1")" \
    --exclude .DS_Store \
    --exclude ._.DS_Store \
    "$1"
  # move into place; if 'link' fails (e.g., due to a 'Cross-device link' error), fall back to 'cp'
  if ! link "$TMPFILE" "$2"; then
    cp "$TMPFILE" "$2"
  fi
  # set file mode to defaults (mktemp zeroes out all group/other bits)
  chmod =rw "$2"
  touch -t "$TIMESTAMP" "$2"
  >&2 printf 'created "%s" from contents of "%s"\n' "$2" "$1"
}

format-output() {
  # Usage: format-output input-directory
  PREFIX=
  # add prefix to OUTPUT name if PREFIX_PATTERN is set
  if [[ ! -z ${PREFIX_PATTERN+missing} ]]; then
    # %B selects the birth time of the inode (file)
    # %SB specifies that the birth time should be converted to a string via the -t timefmt argument
    PREFIX=$(stat -f '%SB' -t "$PREFIX_PATTERN" "$1")
  fi
  printf '%s%s.tar.%s' "$PREFIX" "$1" "$SUFFIX"
}

OUTPUT=$(format-output "$INPUT")

# check that the eventual output does not exist
if [[ -e "$OUTPUT" ]]; then
  >&2 printf '"%s" already exists; not overwriting.\n' "$OUTPUT"
  exit 1
fi

# run main procedure
compress-dir "$INPUT" "$OUTPUT"

# clean up
if ! $KEEP; then
  # use the 'trash' command if there is one
  if command -v trash >/dev/null 2>&1; then
    >&2 printf 'trashing ... '
    trash -v "$INPUT"
  else
    >&2 printf 'moving original to temporary directory...\n'
    mv -v "$INPUT" "$(mktemp -d)"
  fi
fi
